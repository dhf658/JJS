import os
import requests
import time
import re
import logging
from datetime import datetime

# é…ç½®æ—¥å¿—
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ä»GitHub Secretsè·å–é…ç½®
BOT_TOKEN = os.environ.get('BOT_TOKEN')
ADMIN_USERNAMES = os.environ.get('ADMIN_USERNAMES', '@touin77').split(',')

if not BOT_TOKEN:
    logger.error("âŒ æœªè®¾ç½® BOT_TOKEN")
    exit(1)

class GitHubCasinoBot:
    def __init__(self):
        self.base_url = f"https://api.telegram.org/bot{BOT_TOKEN}"
        self.last_update_id = 0
        self.users = {}  # å†…å­˜æ•°æ®åº“
        logger.info("ğŸ¤– å¿«ä¸‰æœºå™¨äººå¯åŠ¨æˆåŠŸ")
    
    def send_message(self, chat_id, text):
        url = f"{self.base_url}/sendMessage"
        data = {
            "chat_id": chat_id,
            "text": text,
            "parse_mode": "HTML"
        }
        try:
            response = requests.post(url, json=data, timeout=10)
            return response.status_code == 200
        except Exception as e:
            logger.error(f"å‘é€æ¶ˆæ¯å¤±è´¥: {e}")
            return False
    
    def get_user(self, user_id, username):
        if user_id not in self.users:
            self.users[user_id] = {
                'username': username,
                'balance': 1000.0,
                'total_deposit': 0.0
            }
        return self.users[user_id]
    
    def update_balance(self, user_id, amount, note=""):
        if user_id in self.users:
            self.users[user_id]['balance'] += amount
            if amount > 0:
                self.users[user_id]['total_deposit'] += amount
            logger.info(f"ç”¨æˆ· {user_id} ä½™é¢æ›´æ–°: {amount}, å¤‡æ³¨: {note}")
    
    def process_message(self, message):
        chat_id = message["chat"]["id"]
        text = message.get("text", "").strip()
        user_id = message["from"]["id"]
        username = f"@{message['from'].get('username', 'unknown')}"
        
        user = self.get_user(user_id, username)
        
        if text == "/start":
            self.send_message(chat_id,
                f"ğŸ² <b>å¿«ä¸‰å¨±ä¹æœºå™¨äºº</b>\n\n"
                f"ğŸ‘¤ æ¬¢è¿ {username}\n"
                f"ğŸ’° å½“å‰ä½™é¢: <b>{user['balance']:.2f}</b>\n\n"
                f"ğŸ¯ <b>ä¸‹æ³¨æ ¼å¼ï¼š</b>\n"
                f"â€¢ å¤§ 100\nâ€¢ å° 50\nâ€¢ å• 30\nâ€¢ åŒ 20\n\n"
                f"å‘é€3ä¸ªéª°å­ ğŸ² å¼€å§‹æ¸¸æˆï¼\n\n"
                f"ğŸ‘‘ ç®¡ç†å‘˜å‘½ä»¤ï¼š\n"
                f"/add @ç”¨æˆ·å é‡‘é¢\n"
                f"/users - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨"
            )
        
        elif text.startswith("/add"):
            if username not in ADMIN_USERNAMES:
                self.send_message(chat_id, "âŒ æ— æƒé™æ‰§è¡Œæ­¤æ“ä½œ")
                return
            
            match = re.match(r'^/add\s+(@\w+)\s+(\d+(?:\.\d+)?)$', text)
            if match:
                target_username = match.group(1)
                amount = float(match.group(2))
                
                # æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
                target_user_id = None
                for uid, user_data in self.users.items():
                    if user_data['username'] == target_username:
                        target_user_id = uid
                        break
                
                if target_user_id:
                    self.update_balance(target_user_id, amount, f"ç®¡ç†å‘˜ {username} å……å€¼")
                    new_balance = self.users[target_user_id]['balance']
                    self.send_message(chat_id,
                        f"âœ… <b>å……å€¼æˆåŠŸï¼</b>\n\n"
                        f"ğŸ‘¤ ç”¨æˆ·: {target_username}\n"
                        f"ğŸ’° é‡‘é¢: {amount:.2f}\n"
                        f"ğŸ“Š æ–°ä½™é¢: {new_balance:.2f}\n"
                        f"ğŸ‘‘ æ“ä½œäºº: {username}"
                    )
                else:
                    self.send_message(chat_id, f"âŒ ç”¨æˆ· {target_username} ä¸å­˜åœ¨")
            else:
                self.send_message(chat_id, "âŒ æ ¼å¼é”™è¯¯ï¼ä½¿ç”¨: /add @ç”¨æˆ·å é‡‘é¢")
        
        elif text == "/users":
            if username not in ADMIN_USERNAMES:
                self.send_message(chat_id, "âŒ æ— æƒé™æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨")
                return
            
            if not self.users:
                self.send_message(chat_id, "æš‚æ— ç”¨æˆ·æ•°æ®")
                return
            
            users_text = "ğŸ‘¥ <b>ç”¨æˆ·åˆ—è¡¨</b>\n\n"
            total_balance = 0
            total_deposit = 0
            
            for user_data in self.users.values():
                users_text += f"ğŸ‘¤ {user_data['username']}\n"
                users_text += f"ğŸ’° ä½™é¢: {user_data['balance']:.2f}\n"
                users_text += f"ğŸ“ˆ å……å€¼: {user_data['total_deposit']:.2f}\n"
                users_text += "â”€" * 20 + "\n"
                
                total_balance += user_data['balance']
                total_deposit += user_data['total_deposit']
            
            users_text += f"\nğŸ“Š <b>ç³»ç»Ÿç»Ÿè®¡</b>\n"
            users_text += f"æ€»ç”¨æˆ·æ•°: {len(self.users)}\n"
            users_text += f"æ€»ä½™é¢: {total_balance:.2f}\n"
            users_text += f"æ€»å……å€¼: {total_deposit:.2f}"
            
            self.send_message(chat_id, users_text)
        
        elif re.match(r'^(å¤§|å°|å•|åŒ)\s+\d+(?:\.\d+)?$', text):
            parts = text.split()
            bet_type = parts[0]
            amount = float(parts[1])
            
            if amount > user['balance']:
                self.send_message(chat_id, f"âŒ ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢: {user['balance']:.2f}")
                return
            
            if amount <= 0:
                self.send_message(chat_id, "âŒ ä¸‹æ³¨é‡‘é¢å¿…é¡»å¤§äº0")
                return
            
            # æ‰£æ¬¾
            self.update_balance(user_id, -amount, f"ä¸‹æ³¨{bet_type}")
            
            new_balance = user['balance']
            self.send_message(chat_id,
                f"âœ… <b>ä¸‹æ³¨æˆåŠŸï¼</b>\n\n"
                f"ğŸ¯ ä¸‹æ³¨: {bet_type}\n"
                f"ğŸ’° é‡‘é¢: {amount:.2f}\n"
                f"ğŸ“Š ä½™é¢: {new_balance:.2f}\n\n"
                f"è¯·å‘é€3ä¸ªéª°å­ ğŸ² å¼€å§‹æ¸¸æˆï¼"
            )
        
        elif "dice" in message:
            # æ¨¡æ‹Ÿéª°å­æ¸¸æˆ
            import random
            dice1 = random.randint(1, 6)
            dice2 = random.randint(1, 6)
            dice3 = random.randint(1, 6)
            total = dice1 + dice2 + dice3
            
            result = "å¤§" if total > 10 else "å°"
            result += "å•" if total % 2 == 1 else "åŒ"
            
            # æ¨¡æ‹Ÿä¸­å¥–ï¼ˆ50%æ¦‚ç‡ï¼‰
            if random.random() > 0.5:
                win_amount = 100.0
                self.update_balance(user_id, win_amount, "æ¸¸æˆä¸­å¥–")
                new_balance = user['balance']
                
                self.send_message(chat_id,
                    f"ğŸ² <b>å¼€å¥–ç»“æœï¼š</b>\n"
                    f"{dice1}+{dice2}+{dice3}={total} {result}\n\n"
                    f"ğŸ‰ <b>æ­å–œä¸­å¥–ï¼</b>\n"
                    f"èµ¢å¾—é‡‘é¢: {win_amount:.2f}\n"
                    f"ğŸ’° ä½™é¢: {new_balance:.2f}\n\n"
                    f"ç»§ç»­ä¸‹æ³¨èµ¢å–æ›´å¤šå¥–åŠ±ï¼"
                )
            else:
                self.send_message(chat_id,
                    f"ğŸ² <b>å¼€å¥–ç»“æœï¼š</b>\n"
                    f"{dice1}+{dice2}+{dice3}={total} {result}\n\n"
                    f"âŒ <b>æœªä¸­å¥–</b>\n"
                    f"ğŸ’° ä½™é¢: {user['balance']:.2f}\n\n"
                    f"ä¸‹æ¬¡å¥½è¿ï¼"
                )
    
    def get_updates(self):
        try:
            url = f"{self.base_url}/getUpdates"
            params = {
                "offset": self.last_update_id + 1,
                "timeout": 30
            }
            response = requests.get(url, params=params, timeout=35)
            
            if response.status_code == 200:
                data = response.json()
                if data.get("ok"):
                    return data.get("result", [])
        except Exception as e:
            logger.error(f"è·å–æ›´æ–°å¤±è´¥: {e}")
        
        return []
    
    def run(self):
        logger.info("å¼€å§‹è½®è¯¢æ¶ˆæ¯...")
        try:
            while True:
                updates = self.get_updates()
                for update in updates:
                    self.last_update_id = update["update_id"]
                    if "message" in update:
                        self.process_message(update["message"])
                
                if not updates:
                    time.sleep(1)
                    
        except KeyboardInterrupt:
            logger.info("æœºå™¨äººåœæ­¢")
        except Exception as e:
            logger.error(f"è¿è¡Œé”™è¯¯: {e}")
            time.sleep(5)
            self.run()  # é‡å¯

if __name__ == "__main__":
    bot = GitHubCasinoBot()
    bot.run()
