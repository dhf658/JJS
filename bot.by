import os
import requests
import time
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# é…ç½®
BOT_TOKEN = os.environ.get('BOT_TOKEN')
ADMIN_USERNAMES = ['touin77']  # æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦@ç¬¦å·

logger.info("ğŸš€ æœºå™¨äººå¯åŠ¨ä¸­...")
logger.info(f"BOT_TOKEN å‰10ä½: {BOT_TOKEN[:10] if BOT_TOKEN else 'None'}")
logger.info(f"ADMIN_USERNAMES: {ADMIN_USERNAMES}")

def test_connection():
    """æµ‹è¯•æœºå™¨äººè¿æ¥"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/getMe"
    try:
        response = requests.get(url, timeout=10)
        logger.info(f"è¿æ¥æµ‹è¯•çŠ¶æ€ç : {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            if data.get('ok'):
                bot_info = data['result']
                logger.info(f"âœ… æœºå™¨äººä¿¡æ¯: {bot_info['first_name']} (@{bot_info['username']})")
                return True
            else:
                logger.error(f"âŒ APIé”™è¯¯: {data}")
                return False
        else:
            logger.error(f"âŒ HTTPé”™è¯¯: {response.status_code}")
            return False
    except Exception as e:
        logger.error(f"âŒ è¿æ¥å¼‚å¸¸: {e}")
        return False

def get_updates(offset=None):
    """è·å–æ¶ˆæ¯æ›´æ–°"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/getUpdates"
    params = {'offset': offset, 'timeout': 30, 'limit': 100}
    
    try:
        response = requests.get(url, params=params, timeout=35)
        if response.status_code == 200:
            data = response.json()
            if data.get('ok'):
                return data['result']
            else:
                logger.error(f"è·å–æ›´æ–°å¤±è´¥: {data}")
        else:
            logger.error(f"HTTPé”™è¯¯: {response.status_code}")
    except Exception as e:
        logger.error(f"è·å–æ›´æ–°å¼‚å¸¸: {e}")
    
    return []

def send_message(chat_id, text):
    """å‘é€æ¶ˆæ¯"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    data = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "HTML"
    }
    
    try:
        response = requests.post(url, json=data, timeout=10)
        if response.status_code == 200:
            logger.info(f"âœ… æ¶ˆæ¯å‘é€æˆåŠŸ: {text[:50]}...")
            return True
        else:
            logger.error(f"âŒ å‘é€å¤±è´¥ {response.status_code}: {response.text}")
            return False
    except Exception as e:
        logger.error(f"âŒ å‘é€å¼‚å¸¸: {e}")
        return False

def process_message(message):
    """å¤„ç†æ¶ˆæ¯"""
    chat_id = message["chat"]["id"]
    text = message.get("text", "").strip()
    user_id = message["from"]["id"]
    username = message["from"].get("username", "unknown")
    
    logger.info(f"ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: {username}: {text}")
    
    if text == "/start":
        send_message(chat_id, 
            "ğŸ² <b>å¿«ä¸‰å¨±ä¹æœºå™¨äºº - è°ƒè¯•ç‰ˆ</b>\n\n"
            "âœ… æœºå™¨äººè¿è¡Œæ­£å¸¸ï¼\n\n"
            "æµ‹è¯•å‘½ä»¤ï¼š\n"
            "/test - æµ‹è¯•å“åº”\n"
            "å¤§ 100 - æµ‹è¯•ä¸‹æ³¨\n"
            "/users - ç”¨æˆ·åˆ—è¡¨(ç®¡ç†å‘˜)"
        )
    
    elif text == "/test":
        send_message(chat_id, "âœ… æœºå™¨äººå“åº”æ­£å¸¸ï¼")
    
    elif text.startswith("/add"):
        if username not in ADMIN_USERNAMES:
            send_message(chat_id, "âŒ æ— æƒé™")
            return
        
        send_message(chat_id, "âœ… ç®¡ç†å‘˜å‘½ä»¤æ¥æ”¶æˆåŠŸ")
    
    elif text == "/users":
        if username not in ADMIN_USERNAMES:
            send_message(chat_id, "âŒ æ— æƒé™")
            return
        
        send_message(chat_id, "ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½æ­£å¸¸")
    
    elif re.match(r'^(å¤§|å°|å•|åŒ)\s+\d+', text):
        send_message(chat_id, "âœ… ä¸‹æ³¨å‘½ä»¤æ¥æ”¶æˆåŠŸï¼")
    
    else:
        send_message(chat_id, f"ğŸ“ æ”¶åˆ°: {text}")

def main():
    logger.info("ğŸ¤– å¼€å§‹ä¸»å¾ªç¯...")
    
    # æµ‹è¯•è¿æ¥
    if not test_connection():
        logger.error("âŒ æœºå™¨äººè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œåœæ­¢è¿è¡Œ")
        return
    
    last_update_id = 0
    
    try:
        while True:
            updates = get_updates(last_update_id + 1)
            logger.info(f"ğŸ“¡ è·å–åˆ° {len(updates)} æ¡æ›´æ–°")
            
            for update in updates:
                update_id = update["update_id"]
                last_update_id = max(last_update_id, update_id)
                
                if "message" in update:
                    process_message(update["message"])
            
            if not updates:
                time.sleep(1)
                
    except Exception as e:
        logger.error(f"ğŸ’¥ ä¸»å¾ªç¯å¼‚å¸¸: {e}")
        time.sleep(5)
        main()  # é‡å¯

if __name__ == "__main__":
    import re
    main()
