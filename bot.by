import os
import requests
import time
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
ADMIN_USERNAMES = ['touin77']

class SimpleBot:
    def __init__(self):
        self.base_url = f"https://api.telegram.org/bot{BOT_TOKEN}"
        
    def send_message(self, chat_id, text):
        url = f"{self.base_url}/sendMessage"
        data = {"chat_id": chat_id, "text": text}
        try:
            requests.post(url, json=data, timeout=5)
            return True
        except:
            return False
    
    def get_updates(self):
        url = f"{self.base_url}/getUpdates"
        try:
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                return response.json().get('result', [])
        except:
            pass
        return []
    
    def process_message(self, message):
        chat_id = message["chat"]["id"]
        text = message.get("text", "")
        
        if text == "/start":
            self.send_message(chat_id, 
                "ğŸ² å¿«ä¸‰æœºå™¨äººæµ‹è¯•\n"
                "å‘é€ /test æµ‹è¯•å“åº”"
            )
        elif text == "/test":
            self.send_message(chat_id, "âœ… æœºå™¨äººæ­£å¸¸å·¥ä½œï¼")
        elif "å¤§" in text or "å°" in text:
            self.send_message(chat_id, "âœ… ä¸‹æ³¨å‘½ä»¤æ”¶åˆ°")

def main():
    bot = SimpleBot()
    logger.info("ğŸ¤– ç®€å•ç‰ˆæœºå™¨äººå¯åŠ¨")
    
    # æµ‹è¯•è¿æ¥
    test_url = f"https://api.telegram.org/bot{BOT_TOKEN}/getMe"
    try:
        response = requests.get(test_url, timeout=10)
        if response.status_code == 200:
            logger.info("âœ… ç½‘ç»œè¿æ¥æ­£å¸¸")
        else:
            logger.error("âŒ ç½‘ç»œè¿æ¥å¤±è´¥")
            return
    except Exception as e:
        logger.error(f"âŒ è¿æ¥å¼‚å¸¸: {e}")
        return
    
    # ç®€å•è½®è¯¢
    last_update = 0
    for i in range(10):  # åªè¿è¡Œ10æ¬¡å¾ªç¯æµ‹è¯•
        logger.info(f"ğŸ” ç¬¬ {i+1} æ¬¡è½®è¯¢")
        updates = bot.get_updates()
        
        for update in updates:
            update_id = update["update_id"]
            if update_id > last_update:
                last_update = update_id
                if "message" in update:
                    bot.process_message(update["message"])
        
        time.sleep(3)
    
    logger.info("ğŸ æµ‹è¯•å®Œæˆ")

if __name__ == "__main__":
    main()
